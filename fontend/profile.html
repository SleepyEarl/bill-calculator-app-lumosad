<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Calculator Dashboard</title>
    <link rel="stylesheet" href="styles/prof.css">
    <link rel="icon" type="image/png" href="img/bill.png">
</head>

<body>

    <nav class="nav">
        <div class="logo">
            <img src="img/bill.png" alt="Bill Calculator" class="logo-img">
            <a href="dashboard.html">BillCalculator</a>
        </div>
    </nav>

    <div class="wrapper">
        <h1>My Profile</h1>

        <form onsubmit="event.preventDefault(); handleProfileUpdate();">
            <div class="input-group">
                <label for="profile_name"></label>
                <input type="text" id="profile_name" placeholder="Your name">
            </div>

            <div class="input-group">
                <label for="profile_email"></label>
                <input type="email" id="profile_email" placeholder="Your email">
            </div>

            <div class="input-group">
                <label for="profile_phone"></label>
                <input type="tel" id="profile_phone" name="profile_phone" placeholder="Your phone number" />
            </div>

            <div class="input-group">
                <label for="profile_address"></label>
                <input type="text" id="profile_address" name="profile_address" placeholder="Your address" />
            </div>
            <input type="submit" class="update-btn" value="Update Profile">
        </form>




        <div class="buttons">
            <button type="button" class="logout" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check authentication on page load and load user data
        document.addEventListener('DOMContentLoaded', async () => {
            const session = await initAuth();
            if (session) {
                await loadUserProfile();
            }
        });

        async function loadUserProfile() {
            const user = await getCurrentUser();
            if (user) {
                // Populate form with user data
                if (user.user_metadata?.full_name) {
                    document.getElementById('profile_name').value = user.user_metadata.full_name;
                }
                if (user.email) {
                    document.getElementById('profile_email').value = user.email;
                }
                if (user.user_metadata?.phone) {
                    document.getElementById('profile_phone').value = user.user_metadata.phone;
                }
                if (user.user_metadata?.address) {
                    document.getElementById('profile_address').value = user.user_metadata.address;
                }  
            }
        }

        async function handleProfileUpdate() {
            const name = document.getElementById('profile_name').value;
            const email = document.getElementById('profile_email').value;
            const phone = document.getElementById('profile_phone').value;
            const address = document.getElementById('profile_address').value;

            const user = await getCurrentUser();
            if (!user) {
                alert('You must be logged in to update your profile!');
                return;
            }

            try {
                // Update user metadata
               const { data, error } = await supabaseClient.auth.updateUser({
                            data: {
                            full_name: name,
                            phone: phone,
                            address: address
                        }
                    });
                if (error) {
                    alert('Error updating profile: ' + error.message);
                    return;
                }

                alert('Profile updated successfully!');
            } catch (error) {
                alert('Error updating profile: ' + error.message);
            }
        }

        async function handleLogout() {
            const success = await signOut();
            if (success) {
                window.location.href = 'signin.html';
            } else {
                alert('Error logging out. Please try again.');
            }
        }
    </script>


</body>

</html>